const TelegramBot = require("node-telegram-bot-api");
const axios = require("axios");

const TELEGRAM_TOKEN = process.env.TELEGRAM_TOKEN;
const REPLICATE_API_KEY = process.env.REPLICATE_API_KEY;

const bot = new TelegramBot(TELEGRAM_TOKEN, { polling: true });

bot.on("message", async (msg) => {
  const chatId = msg.chat.id;
  const prompt = msg.text;

  bot.sendMessage(chatId, "⏳ Membuat video...");

  try {
    const create = await axios.post(
      "https://api.replicate.com/v1/models/minimax/video-01/predictions",
      {
        input: { prompt, num_frames: 16, fps: 8, aspect_ratio: "16:9" }
      },
      {
        headers: {
          Authorization: `Bearer ${REPLICATE_API_KEY}`,
          "Content-Type": "application/json"
        }
      }
    );

    const predictionId = create.data.id;
    let status = create.data.status;
    let videoUrl = null;

    while (status !== "succeeded" && status !== "failed") {
      await new Promise(r => setTimeout(r, 3000));

      const check = await axios.get(
        `https://api.replicate.com/v1/predictions/${predictionId}`,
        { headers: { Authorization: `Bearer ${REPLICATE_API_KEY}` } }
      );

      status = check.data.status;
      if (status === "succeeded") videoUrl = check.data.output[0];
    }

    if (videoUrl) bot.sendVideo(chatId, videoUrl);
  } catch (err) {
    bot.sendMessage(chatId, "❌ Error.");
    console.log(err.response?.data || err);
  }
});
